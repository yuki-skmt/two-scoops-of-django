# Two Scoops of Django 3.x

## 7. クエリとデータベース層
- Djangoの**オブジェクトリレーショナルモデル (ORM)** は、よくあるユースケースに対応した適切なSQLクエリを生成するだけでなく、検証、セキュアなモデルへのアクセス、更新の機能を提供し、生産性の向上に貢献する。
- これにより、異なるRDBMSで動作するコードを簡単に書くことができる。
- Djangoのサードパーティパッケージのエコシステムの多くは、ORMのこの機能によって支えられている。
- DjangoのORMは他のORMと同様に、様々な型のデータを、サポートされているデータベース間で一貫して使えるようなオブジェクトに変換し、そのオブジェクトを操作するためのメソッドを提供する。
- ほとんどの場合で実装されたことをうまく実行するが、Djangoには癖がある。Djangoの使い方を学ぶ上で、その癖を理解することは重要である。

### 7.1 単一のオブジェクトには get_object_or_404() を使う
- 詳細ページのように、単一のオブジェクトを取得してそれに対して何かをしたい場合には、 `get()`の代わりに`get_object_or_404()`を使う。

- [警告] `get_object_or_404()` はビュー専用
  - この関数はビューでのみ使用する。
  - ヘルパー関数やフォーム、モデルメソッドなど、ビューではないものやビューに直接関係しないものには使わない。

### 7.2 例外を投げる可能性のあるクエリに注意する
- `get_object_or_404()` ショートカットで単一のDjangoモデルインスタンスを取得する場合、 `try-except`ブロックで囲む必要はない。(それは `get_object_or_404()` が既にやっている)。
- しかし、他のほとんどの状況では `try-except` ブロックを使用する必要があります。
- いくつかのヒントを紹介する。

#### 7.2.1 ObjectDoesNotExist vs. DoesNotExist
- `ObjectDoesNotExist`はどのモデルオブジェクトにも適用できるが、`DoesNotExist`は特定のモデルに対して適用する。

```python:object_does_not_exist.py
from django.core.exceptions import ObjectDoesNotExist

from flavors.models import Flavor
from store.exceptions import OutOfStock

def list_flavor_line_item(sku):
    try:
        return Flavor.objects.get(sku=sku, quantity__gt=0)
    except Flavor.DoesNotExist:
        msg = 'We are out of {0}'.format(sku)
        raise OutOfStock(msg)

def list_any_line_item(model, sku):
    try:
        return model.objects.get(sku=sku, quantity__gt=0)
    except ObjectDoesNotExist:
        msg = 'We are out of {0}'.format(sku)
        raise OutOfStock(msg)
```

#### 7.2.2 1つのオブジェクトが期待されるのに3つのオブジェクトを返す場合
- クエリが複数のオブジェクトを返す可能性がある場合は、`MultipleObjectsReturned`の例外をチェックする。

```python:multiple_objects_returned.py
from flavors.models import Flavor
from store.exceptions import OutOfStock, CorruptedDatabase

def list_flavor_line_item(sku):
    try:
        return Flavor.objects.get(sku=sku, quantity__gt=0)
    except Flavor.DoesNotExist:
        msg = 'We are out of {}'.format(sku)
        raise OutOfStock(msg)
    except Flavor.MultipleObjectsReturned:
        msg = 'Multiple items have SKU {}. Please fix!'.format(sku)
        raise CorruptedDatabase(msg)
```

### 7.3 遅延評価を使ってクエリを読みやすくする
- DjangoのORMはとても強力です。そしてその力には、コードを読みやすく、保守しやすくする責任が伴う。
- 複雑なクエリでは、少ない行数で多くの機能を連ねないようにする必要がある。



