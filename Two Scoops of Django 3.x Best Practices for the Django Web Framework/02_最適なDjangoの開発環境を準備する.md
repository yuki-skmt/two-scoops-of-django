# Two Scoops of Django 3.x

## 2. 最適なDjangoの開発環境を準備する

### 2.1 どこでも同じデータベースエンジンを使う
- ローカルの開発ではSQLite3を使い、本番環境ではPostgreSQL (またはMySQL)を使う、というのはよく見られるケースだが、これが落とし穴となる。
- このセクションでは、開発用と本番用で異なるデータベースエンジンを使用した場合に遭遇する問題を紹介する。

#### 2.1.1 本番データの正確なコピーをローカルで調べることができない
- 本番用DBがローカルの開発用DBと異なる場合、本番用DBの正確なコピーを取得してローカルでデータを検証することはできない。
  - 本番環境からSQLダンプを生成してローカルにインポートすることはできるが、エクスポートとインポートの後に正確なコピーが得られるとは限らない。

#### 2.1.2 データベースによってフィールドの種類や制約が違う
- フィールドデータの型キャストの扱いが異なる。
- 例えば、ローカル開発でSQLite3を、本番環境でPostgreSQLを使った場合。
  - SQLite3は動的な弱い型付けをしており、PostgreSQLは強い型付けを使用しているので、最終的に問題が発生する。
  - DjangoのORMにはSQLite3をより強い型付けで操作する機能があるが、開発中のフォームやモデルの検証ミスは、本番サーバで実行されるまで(テストでも)検出されない。
  - 本番環境では、PostgreSQLやMySQLが、ローカルでは見たことのない制約エラーを投げることがある。そしてそれは、ローカルで同じ環境をセットアップしない限り再現することが難しい。
  - ほとんどの問題は、型付けの強いDB(PostgreSQLやMySQLなど)でプロジェクトを実行するまで発見できない。
- [TIP] Django + PostgreSQLの優れた連携性
  - 多くのDjango開発者が、開発、ステージング、QA、本番システムなどのあらゆる環境でPostgreSQLを使うことを好んでいる。

### 2.1.3 フィクスチャは魔法の解決策ではない
- フィクスチャは、シンプルなテストデータセットを作成するのに適している。
  - 特にプロジェクトの初期段階で、開発中に仮データをDBに入れておく必要がある場合などに効果的。
- 一方でフィクスチャは、DBに依存しない方法で、大規模なデータセットをあるDBから別のDBに移行するための信頼できる手段ではない。
- [警告] 本番環境のDjangoでSQLite3を使用しないこと。
  - 2人以上のユーザを想定していたり、軽い並行性以上のものを必要とするWebプロジェクトにとって、SQLite3 は悪夢のような存在である。
  - 問題発生後にデータをSQLite3から並行処理用に設計されたもの (例えば、PostgreSQL)に移行することは非常に難しい。

### 2.2 pipとVirtualenv (または venv) の使用
- pip と virtualenv の両方に精通することを強く推奨する。
  - これらはDjangoプロジェクトのデファクトスタンダードであり、Djangoを使っているほとんどの企業がこれらのツールに依存している。
- pip は Python Package Index とそのミラーからPythonパッケージを取得するツールである。
  - Pythonパッケージの管理とインストールに使用され、Linux以外のほとんどのPythonインストーラに付属されている。
- Virtualenvは、パッケージの依存関係を維持するために独立したPython環境を作成するためのツールである。
  - 同時に複数のプロジェクトで作業していて、プロジェクト間で使用しているライブラリのバージョンが異なるような状況で最適である。

- [PACKAGE TIP] **Conda**: Virtualenvの代替。
  - Windows、Mac、Linuxで動作するオープンソースのパッケージ管理システムおよび環境管理システム。
  - コンパイルされたバイナリをインストールしたいWindowsプラットフォームのユーザにとっては最も使いやすいものとなっている。
  - また、Condaは複数のPythonのバージョンを簡単に扱うことができる。
  - [Conda](docs.conda.io/)

- [PACKAGE TIP] **Poetry**および**Pipenv**: Pip+Virtualenvの代替。
  - Poetryは、Pythonプロジェクトの依存関係の宣言、管理、インストールを支援し、あらゆる場所で正しいスタックを確保することができる。
    - 直感的なCLIで多くの機能をカプセル化している点が評価されている。
    - 人気があり、安定している。
    - [Poetry](python-poetry.org)

  - Pipenvは、pipとvirtualenvを1つのインターフェースにまとめたツール。
    - 環境の作成などのプロセスを自動化し、再現性のあるビルドを可能にするファイルであるPipfile.lockを導入しています。
    - [再現性のあるビルド](https://ja.wikipedia.org/wiki/%E5%86%8D%E7%8F%BE%E6%80%A7%E3%81%AE%E3%81%82%E3%82%8B%E3%83%93%E3%83%AB%E3%83%89)
    - [Pipenv](pipenv.pypa.io/)
- [警告] Linuxディストリビューションでは、Pipは必ずしもデフォルトでインストールされていない。
  - 多くのLinuxディストリビューションでは、メンテナがいくつかのモジュールを標準的なPythonライブラリから削除し、それらを個別のインストール可能なパッケージにしている。
  - 例えば、ubuntuではpython3-pip, python3-setuptools, python3-wheel, python3-distutilsをインストールする必要がある。
  - Windows 10では近い将来、WSL2 (Linux on Windows) の安定版が提供される予定なので、同様にこれらのユーザーに影響を与える可能性がある。

#### 2.2.1 virtualenvwrapper
- MacやLinux用のvirtualenvwrapperや，Windows用のvirtualenvwrapper-winの使用を推奨する。

- virtualenvwrapperを使用していない場合
  - コマンドが冗長。

```terminal
$ source ~/.virtualenvs/twoscoops/bin/activate
```

- virtualenvwrapperを使用した場合
  - コマンドが簡潔。

```terminal
$ workon twoscoops
```

### 2.3 PipでDjangoとその他の依存先をインストールする
- Djangoをインストールする方法は複数あるが、pip とrequirementsファイルを使ったインストール方法を推奨する。
  - requirementsファイルには各パッケージの名前と、必要に応じて適切なバージョン範囲が記載されている。pip を使って、このリストからパッケージを仮想環境にインストールする。
- [TIP] PYTHONPATHの設定
  - コマンドラインや環境変数を理解している場合は、仮想環境のPYTHONPATHを設定することで、django-adminコマンドを使用してサイトのサービスやその他のタスクを実行することができる。
  - また、virtualenvのPYTHONPATHに、最新バージョンのpipが入っているカレントディレクトリを設定することもできる。
  - プロジェクトのルートディレクトリで`pip install -e` を実行すると、カレントディレクトリがその場で編集できるパッケージとしてインストールされる。

### 2.4 Gitを使用し、バージョン管理を行う
- バージョン管理 (リビジョン管理やソース管理とも呼ばれる)
- Django プロジェクトで作業をするときはいつも、バージョン管理システムを使ってコードの変更を記録しておくべきである。
  - Gitは、あらゆる言語やツールの開発者にとっての業界標準であり、ブランチの作成や変更のマージが簡単にできる。
- バージョン管理システムを使用する際には、コードリポジトリのローカルコピーを持つだけでなく、コードホスティングサービスを使用してバックアップを取ることも重要です。
- その中でも、GitHubやGitLabの利用を推奨する。

### 2.5 同一の環境を用意する
- 同一の環境というのは、「現実的に可能な限り」同一な環境を指す。
  - 本番環境が1万台のサーバーで構成されている場合に、開発用にさらに1万台のローカルサーバーを用意するのは現実的ではない。
- しかし、以下のような環境の違いに関しては排除することができる。
  - OSの違い
  - Pythonセットアップの違い
  - 開発者間の違い
- 同一の開発環境をセットアップする最も一般的な方法は、Dockerを使うことである。

#### 2.5.1 Docker
- 現状の環境のコンテナ化における業界標準。
- Windowsを含むすべてのOSで優れたサポートを提供している。
- Dockerでの作業はVMの中での開発に似ているが、より軽量である。
- DockerコンテナはホストOSを共有しているが、独自の分離されたプロセスとメモリ空間を持っている。
- Dockerではユニオン・キャパブル・ファイルシステムを採用しているため、ゼロから構築するのではなく、スナップショットと差分を使って素早くコンテナを構築することができる。
- ローカルでの開発を目的とした場合、Dockerの最大のメリットは、開発と本番に近い環境を簡単に構築できることである。
- 例えば、開発用のラップトップがMac (またはWindows、Centosなど)で、プロジェクトの構成がUbuntuに特化している場合、Docker Compose経由でDockerを使用して、プロジェクトに必要なすべてのパッケージとセットアップ構成を備えた仮想的なUbuntu開発環境をローカルに素早くセットアップすることができる。
- 以下のようなことが可能。
  - プロジェクトの開発チームの全員に同一のローカル開発環境を設定する。
  - これらのローカル開発環境を、ステージングサーバー、テストサーバー、本番サーバーと同様の方法で設定する。
- ほとんどの状況で不要な過剰な複雑さがあり、それが潜在的なデメリットになることがある。OSレベルの違いをあまり気にしないような単純なプロジェクトでは、Dockerを使用しない方が効率的である。
- また、古い開発マシンでは、軽量コンテナであっても実行時にパフォーマンスが低下する。新しいマシンであっても、小さいながらも顕著なオーバーヘッドが生じる。

### 2.6 まとめ
- この章では、以下を取り上げた。
  - 開発で本番と同じデータベースを使うこと
  - pip
  - virtualenv
  - venv
  - conda
  - poetry
  - pipenv
  - バージョン管理
  - Docker
- これらは Djangoだけでなく、多くのPythonソフトウェア開発で使われている。
